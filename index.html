<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidbok OB - Registro de Horas</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF y html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        .ob-base { background-color: #dbeafe; }
        .ob-1 { background-color: #ffedd5; }
        .ob-2 { background-color: #fee2e2; }
        .ob-3 { background-color: #ede9fe; }
        .ob-4 { background-color: #dcfce7; }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Barra de navegación -->
        <nav class="bg-primary text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-clock text-2xl mr-2"></i>
                    <h1 class="text-xl font-bold">Tidbok OB</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center">
                        <span class="w-3 h-3 rounded-full bg-green-500 mr-1"></span>
                        <span class="text-sm hidden md:inline">Online</span>
                    </div>
                    
                    <div class="relative">
                        <select id="language-select" class="bg-primary border border-white rounded px-2 py-1 text-white">
                            <option value="es">Español</option>
                            <option value="en">English</option>
                            <option value="sv">Svenska</option>
                        </select>
                    </div>
                    
                    <div id="user-info" class="hidden">
                        <div class="flex items-center">
                            <img id="user-avatar" class="w-8 h-8 rounded-full mr-2" src="https://ui-avatars.com/api/?background=random&name=U" alt="Avatar">
                            <span id="user-name" class="mr-2">Usuario</span>
                            <button id="logout-btn" class="bg-white text-primary px-3 py-1 rounded hover:bg-gray-200 transition">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- Pantalla de autenticación -->
            <div id="auth-screen" class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Iniciar sesión</h2>
                    <p class="text-gray-600">Accede a tu cuenta para gestionar tus horas</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="email">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="password">Contraseña</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                
                <div class="mb-6">
                    <button id="login-btn" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                        Iniciar sesión
                    </button>
                    <button id="register-btn" class="w-full mt-2 bg-secondary text-white py-2 px-4 rounded-md hover:bg-green-500 transition">
                        Crear cuenta
                    </button>
                </div>
                
                <div id="auth-message" class="text-center text-red-500"></div>
            </div>

            <!-- Pantalla principal de la aplicación (inicialmente oculta) -->
            <div id="app-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Sección izquierda: Registro de horas y proyectos -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Card: Registrar horas -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Registrar horas</h2>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 mb-2">Fecha</label>
                                    <input type="date" id="work-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Proyecto</label>
                                    <select id="project-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">Seleccionar proyecto</option>
                                    </select>
                                    <button id="new-project-btn" class="mt-2 text-sm text-primary hover:underline">
                                        <i class="fas fa-plus mr-1"></i> Nuevo proyecto
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Hora inicio</label>
                                        <input type="time" id="start-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Hora fin</label>
                                        <input type="time" id="end-time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Descanso (minutos)</label>
                                    <input type="number" id="break-time" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Compañeros</label>
                                    <input type="text" id="colleagues" placeholder="Nombres separados por comas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                </div>
                                
                                <div>
                                    <label class="block text-gray-700 mb-2">Notas</label>
                                    <textarea id="notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                                </div>
                                
                                <button id="save-hours-btn" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-blue-600 transition">
                                    Guardar registro
                                </button>
                            </div>
                        </div>
                        
                        <!-- Card: Gestión de proyectos -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">Mis proyectos</h2>
                                <button id="create-project-btn" class="bg-primary text-white p-2 rounded-full hover:bg-blue-600 transition">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            
                            <div id="projects-list" class="space-y-2 max-h-60 overflow-y-auto scrollbar-hide">
                                <!-- Proyectos se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sección derecha: Historial y estadísticas -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Card: Resumen de horas OB -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen de horas OB</h2>
                            
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div class="ob-base p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold" id="base-hours">0.00</div>
                                    <div class="text-sm">Sueldo base</div>
                                </div>
                                <div class="ob-1 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold" id="ob1-hours">0.00</div>
                                    <div class="text-sm">OB 1</div>
                                </div>
                                <div class="ob-2 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold" id="ob2-hours">0.00</div>
                                    <div class="text-sm">OB 2</div>
                                </div>
                                <div class="ob-3 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold" id="ob3-hours">0.00</div>
                                    <div class="text-sm">OB 3</div>
                                </div>
                                <div class="ob-4 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold" id="ob4-hours">0.00</div>
                                    <div class="text-sm">OB 4</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card: Historial de horas -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-gray-800">Historial de horas</h2>
                                <div class="flex space-x-2">
                                    <select id="filter-year" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="all">Todos los años</option>
                                    </select>
                                    <select id="filter-month" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="all">Todos los meses</option>
                                    </select>
                                    <button id="export-pdf" class="bg-primary text-white p-2 rounded-md hover:bg-blue-600 transition">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button id="export-json" class="bg-secondary text-white p-2 rounded-md hover:bg-green-500 transition">
                                        <i class="fas fa-file-code"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Horas</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalles</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hours-history" class="bg-white divide-y divide-gray-200">
                                        <!-- Historial se cargará aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Card: Estadísticas -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Estadísticas</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-medium text-gray-700 mb-3">Distribución por proyecto</h3>
                                    <canvas id="project-chart" height="250"></canvas>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-700 mb-3">Horas por semana</h3>
                                    <canvas id="weekly-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-dark text-white py-4 mt-auto">
            <div class="container mx-auto px-4 text-center">
                <p>Tidbok OB &copy; 2023 - Todos los derechos reservados</p>
            </div>
        </footer>
    </div>

    <!-- Modales -->
    <!-- Modal de nuevo proyecto -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Proyecto</h3>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nombre del proyecto</label>
                <input type="text" id="project-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Descripción (opcional)</label>
                <textarea id="project-description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-project-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                <button id="save-project-btn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de detalle de registro -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Detalle del Registro</h3>
            
            <div id="detail-content" class="space-y-3">
                <!-- Contenido dinámico -->
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="close-detail-btn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDLezJUZMmeLllsdEPCUVkDBKwwR6OuoD8",
            authDomain: "userbase-5061c.firebaseapp.com",
            databaseURL: "https://userbase-5061c-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "userbase-5061c",
            storageBucket: "userbase-5061c.firebasestorage.app",
            messagingSenderId: "414829360217",
            appId: "1:414829360217:web:21d0839ee0ccfbea336d48"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Variables globales
        let currentUser = null;
        let projects = [];
        let timeEntries = [];
        let language = 'es';
        
        // Traducciones
        const translations = {
            es: {
                login: "Iniciar sesión",
                register: "Crear cuenta",
                workDate: "Fecha",
                project: "Proyecto",
                startTime: "Hora inicio",
                endTime: "Hora fin",
                breakTime: "Descanso (minutos)",
                colleagues: "Compañeros",
                notes: "Notas",
                saveHours: "Guardar registro",
                myProjects: "Mis proyectos",
                newProject: "Nuevo proyecto",
                obSummary: "Resumen de horas OB",
                baseSalary: "Sueldo base",
                ob1: "OB 1",
                ob2: "OB 2",
                ob3: "OB 3",
                ob4: "OB 4",
                history: "Historial de horas",
                allYears: "Todos los años",
                allMonths: "Todos los meses",
                date: "Fecha",
                hours: "Horas",
                details: "Detalles",
                actions: "Acciones",
                statistics: "Estadísticas",
                projectDistribution: "Distribución por proyecto",
                weeklyHours: "Horas por semana",
                cancel: "Cancelar",
                save: "Guardar",
                projectName: "Nombre del proyecto",
                projectDescription: "Descripción (opcional)",
                registerDetail: "Detalle del Registro",
                close: "Cerrar",
                delete: "Eliminar",
                edit: "Editar",
                totalHours: "Horas totales",
                colleaguesPlaceholder: "Nombres separados por comas"
            },
            en: {
                login: "Login",
                register: "Create account",
                workDate: "Date",
                project: "Project",
                startTime: "Start time",
                endTime: "End time",
                breakTime: "Break (minutes)",
                colleagues: "Colleagues",
                notes: "Notes",
                saveHours: "Save entry",
                myProjects: "My projects",
                newProject: "New project",
                obSummary: "OB Hours Summary",
                baseSalary: "Base salary",
                ob1: "OB 1",
                ob2: "OB 2",
                ob3: "OB 3",
                ob4: "OB 4",
                history: "Time History",
                allYears: "All years",
                allMonths: "All months",
                date: "Date",
                hours: "Hours",
                details: "Details",
                actions: "Actions",
                statistics: "Statistics",
                projectDistribution: "Project distribution",
                weeklyHours: "Weekly hours",
                cancel: "Cancel",
                save: "Save",
                projectName: "Project name",
                projectDescription: "Description (optional)",
                registerDetail: "Entry Detail",
                close: "Close",
                delete: "Delete",
                edit: "Edit",
                totalHours: "Total hours",
                colleaguesPlaceholder: "Names separated by commas"
            },
            sv: {
                login: "Logga in",
                register: "Skapa konto",
                workDate: "Datum",
                project: "Projekt",
                startTime: "Starttid",
                endTime: "Sluttid",
                breakTime: "Rast (minuter)",
                colleagues: "Kollegor",
                notes: "Anteckningar",
                saveHours: "Spara post",
                myProjects: "Mina projekt",
                newProject: "Nytt projekt",
                obSummary: "OB-timmar Sammanfattning",
                baseSalary: "Baslön",
                ob1: "OB 1",
                ob2: "OB 2",
                ob3: "OB 3",
                ob4: "OB 4",
                history: "Tidshistorik",
                allYears: "Alla år",
                allMonths: "Alla månader",
                date: "Datum",
                hours: "Timmar",
                details: "Detaljer",
                actions: "Åtgärder",
                statistics: "Statistik",
                projectDistribution: "Projektfördelning",
                weeklyHours: "Veckotimmar",
                cancel: "Avbryt",
                save: "Spara",
                projectName: "Projektnamn",
                projectDescription: "Beskrivning (valfritt)",
                registerDetail: "Postdetalj",
                close: "Stäng",
                delete: "Ta bort",
                edit: "Redigera",
                totalHours: "Totalt antal timmar",
                colleaguesPlaceholder: "Namn separerade med kommatecken"
            }
        };
        
        // Función para traducir la interfaz
        function translateUI() {
            const lang = translations[language];
            
            // Actualizar textos
            document.getElementById('login-btn').textContent = lang.login;
            document.getElementById('register-btn').textContent = lang.register;
            document.querySelector('label[for="work-date"]').textContent = lang.workDate;
            document.querySelector('label[for="project-select"]').textContent = lang.project;
            document.querySelector('label[for="start-time"]').textContent = lang.startTime;
            document.querySelector('label[for="end-time"]').textContent = lang.endTime;
            document.querySelector('label[for="break-time"]').textContent = lang.breakTime;
            document.querySelector('label[for="colleagues"]').textContent = lang.colleagues;
            document.querySelector('label[for="notes"]').textContent = lang.notes;
            document.getElementById('save-hours-btn').textContent = lang.saveHours;
            document.querySelector('#app-content > div > div:nth-child(1) > div:nth-child(2) > div > h2').textContent = lang.myProjects;
            document.getElementById('new-project-btn').innerHTML = `<i class="fas fa-plus mr-1"></i> ${lang.newProject}`;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > h2').textContent = lang.obSummary;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > div > div:nth-child(1) > div:nth-child(2)').textContent = lang.baseSalary;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > div > div:nth-child(2) > div:nth-child(2)').textContent = lang.ob1;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > div > div:nth-child(3) > div:nth-child(2)').textContent = lang.ob2;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > div > div:nth-child(4) > div:nth-child(2)').textContent = lang.ob3;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(1) > div > div:nth-child(5) > div:nth-child(2)').textContent = lang.ob4;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(2) > div > div:nth-child(1) > h2').textContent = lang.history;
            document.querySelector('#project-modal > div > h3').textContent = lang.newProject;
            document.querySelector('#project-modal > div > div:nth-child(2) > label').textContent = lang.projectName;
            document.querySelector('#project-modal > div > div:nth-child(3) > label').textContent = lang.projectDescription;
            document.getElementById('cancel-project-btn').textContent = lang.cancel;
            document.getElementById('save-project-btn').textContent = lang.save;
            document.querySelector('#detail-modal > div > h3').textContent = lang.registerDetail;
            document.getElementById('close-detail-btn').textContent = lang.close;
            document.getElementById('colleagues').placeholder = lang.colleaguesPlaceholder;
            
            // Actualizar tabla
            const headers = document.querySelectorAll('thead th');
            if (headers.length >= 5) {
                headers[0].textContent = lang.date;
                headers[1].textContent = lang.project;
                headers[2].textContent = lang.hours;
                headers[3].textContent = lang.details;
                headers[4].textContent = lang.actions;
            }
            
            // Actualizar estadísticas
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(3) > h2').textContent = lang.statistics;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(3) > div > div:nth-child(1) > h3').textContent = lang.projectDistribution;
            document.querySelector('#app-content > div > div:nth-child(2) > div:nth-child(3) > div > div:nth-child(2) > h3').textContent = lang.weeklyHours;
        }
        
        // Función para calcular las horas OB
        function calculateOBHours(start, end, breakMinutes) {
            // Convertir a objetos Date
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            // Calcular diferencia total en horas
            const diffMs = endDate - startDate;
            let totalHours = diffMs / (1000 * 60 * 60);
            
            // Restar el descanso
            const breakHours = breakMinutes / 60;
            totalHours -= breakHours;
            
            // Simular cálculo de horas OB
            const obHours = {
                base: totalHours * 0.7,
                ob1: totalHours * 0.1,
                ob2: totalHours * 0.1,
                ob3: totalHours * 0.05,
                ob4: totalHours * 0.05
            };
            
            return {
                total: totalHours,
                breakdown: obHours
            };
        }
        
        // Función para formatear horas
        function formatHours(hours) {
            return hours.toFixed(2);
        }
        
        // Función para cargar proyectos
        function loadProjects(userId) {
            const projectsRef = database.ref(`users/${userId}/projects`);
            
            projectsRef.on('value', (snapshot) => {
                projects = [];
                const projectsList = document.getElementById('projects-list');
                projectsList.innerHTML = '';
                
                snapshot.forEach((childSnapshot) => {
                    const project = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    projects.push(project);
                    
                    // Agregar al select de proyectos
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    document.getElementById('project-select').appendChild(option);
                    
                    // Agregar a la lista de proyectos
                    const projectElement = document.createElement('div');
                    projectElement.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    projectElement.innerHTML = `
                        <div>
                            <span class="font-medium">${project.name}</span>
                            ${project.description ? `<p class="text-sm text-gray-500">${project.description}</p>` : ''}
                        </div>
                        <button class="delete-project text-red-500 hover:text-red-700" data-id="${project.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    projectsList.appendChild(projectElement);
                });
                
                // Agregar event listeners para eliminar proyectos
                document.querySelectorAll('.delete-project').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const projectId = e.currentTarget.getAttribute('data-id');
                        deleteProject(projectId);
                    });
                });
            });
        }
        
        // Función para cargar historial de horas
        function loadTimeEntries(userId) {
            const timeRef = database.ref(`users/${userId}/timeEntries`);
            
            timeRef.on('value', (snapshot) => {
                timeEntries = [];
                const historyBody = document.getElementById('hours-history');
                historyBody.innerHTML = '';
                
                // Limpiar resumen
                document.getElementById('base-hours').textContent = '0.00';
                document.getElementById('ob1-hours').textContent = '0.00';
                document.getElementById('ob2-hours').textContent = '0.00';
                document.getElementById('ob3-hours').textContent = '0.00';
                document.getElementById('ob4-hours').textContent = '0.00';
                
                // Acumuladores para estadísticas
                let projectStats = {};
                let weekStats = {};
                let obSummary = {
                    base: 0,
                    ob1: 0,
                    ob2: 0,
                    ob3: 0,
                    ob4: 0
                };
                
                snapshot.forEach((childSnapshot) => {
                    const entry = {
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    };
                    timeEntries.push(entry);
                    
                    // Calcular horas
                    const startTime = new Date(entry.startTime);
                    const endTime = new Date(entry.endTime);
                    const obHours = calculateOBHours(startTime, endTime, entry.breakTime || 0);
                    
                    // Actualizar resumen OB
                    obSummary.base += obHours.breakdown.base;
                    obSummary.ob1 += obHours.breakdown.ob1;
                    obSummary.ob2 += obHours.breakdown.ob2;
                    obSummary.ob3 += obHours.breakdown.ob3;
                    obSummary.ob4 += obHours.breakdown.ob4;
                    
                    // Actualizar estadísticas por proyecto
                    const projectName = entry.projectName || 'Sin proyecto';
                    if (!projectStats[projectName]) {
                        projectStats[projectName] = 0;
                    }
                    projectStats[projectName] += obHours.total;
                    
                    // Actualizar estadísticas por semana
                    const weekStart = getWeekStartDate(startTime);
                    const weekKey = weekStart.toISOString().split('T')[0];
                    if (!weekStats[weekKey]) {
                        weekStats[weekKey] = 0;
                    }
                    weekStats[weekKey] += obHours.total;
                    
                    // Formatear fecha
                    const dateStr = new Date(entry.startTime).toLocaleDateString();
                    
                    // Agregar a la tabla
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap">${dateStr}</td>
                        <td class="px-4 py-2">${projectName}</td>
                        <td class="px-4 py-2">${formatHours(obHours.total)}</td>
                        <td class="px-4 py-2">
                            <button class="view-detail text-primary hover:underline" data-id="${entry.id}">
                                <i class="fas fa-eye mr-1"></i> ${translations[language].details}
                            </button>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <button class="text-blue-500 hover:text-blue-700 mr-2 edit-entry" data-id="${entry.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700 delete-entry" data-id="${entry.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    historyBody.appendChild(row);
                });
                
                // Actualizar resumen OB
                document.getElementById('base-hours').textContent = formatHours(obSummary.base);
                document.getElementById('ob1-hours').textContent = formatHours(obSummary.ob1);
                document.getElementById('ob2-hours').textContent = formatHours(obSummary.ob2);
                document.getElementById('ob3-hours').textContent = formatHours(obSummary.ob3);
                document.getElementById('ob4-hours').textContent = formatHours(obSummary.ob4);
                
                // Actualizar gráficos
                updateCharts(projectStats, weekStats);
                
                // Agregar event listeners para ver detalles
                document.querySelectorAll('.view-detail').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.getAttribute('data-id');
                        showEntryDetail(entryId);
                    });
                });
                
                // Agregar event listeners para eliminar entradas
                document.querySelectorAll('.delete-entry').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.getAttribute('data-id');
                        deleteTimeEntry(entryId);
                    });
                });
            });
        }
        
        // Función para obtener el inicio de la semana
        function getWeekStartDate(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajuste para que la semana comience el lunes
            return new Date(d.setDate(diff));
        }
        
        // Función para actualizar gráficos
        function updateCharts(projectStats, weekStats) {
            // Gráfico de distribución por proyecto
            const projectCtx = document.getElementById('project-chart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (window.projectChart) {
                window.projectChart.destroy();
            }
            
            window.projectChart = new Chart(projectCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(projectStats),
                    datasets: [{
                        data: Object.values(projectStats),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: translations[language].projectDistribution
                        }
                    }
                }
            });
            
            // Gráfico de horas por semana
            const weeklyCtx = document.getElementById('weekly-chart').getContext('2d');
            
            // Ordenar semanas
            const sortedWeeks = Object.keys(weekStats).sort();
            const weekLabels = sortedWeeks.map(week => {
                const date = new Date(week);
                return `Sem ${date.getWeek()}`;
            });
            
            // Destruir gráfico anterior si existe
            if (window.weeklyChart) {
                window.weeklyChart.destroy();
            }
            
            window.weeklyChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: translations[language].weeklyHours,
                        data: sortedWeeks.map(week => weekStats[week]),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Función para crear un nuevo proyecto
        function createProject() {
            const name = document.getElementById('project-name').value.trim();
            const description = document.getElementById('project-description').value.trim();
            
            if (!name) {
                alert('Por favor ingresa un nombre para el proyecto');
                return;
            }
            
            const newProject = {
                name,
                description,
                createdAt: new Date().toISOString()
            };
            
            const projectsRef = database.ref(`users/${currentUser.uid}/projects`);
            projectsRef.push(newProject);
            
            // Cerrar modal y limpiar campos
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('project-name').value = '';
            document.getElementById('project-description').value = '';
        }
        
        // Función para eliminar proyecto
        function deleteProject(projectId) {
            if (confirm('¿Estás seguro de que quieres eliminar este proyecto? Esta acción no se puede deshacer.')) {
                const projectRef = database.ref(`users/${currentUser.uid}/projects/${projectId}`);
                projectRef.remove();
            }
        }
        
        // Función para guardar registro de horas
        function saveTimeEntry() {
            const date = document.getElementById('work-date').value;
            const projectId = document.getElementById('project-select').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const breakTime = document.getElementById('break-time').value || 0;
            const colleagues = document.getElementById('colleagues').value;
            const notes = document.getElementById('notes').value;
            
            if (!date || !projectId || !startTime || !endTime) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            // Obtener nombre del proyecto
            const project = projects.find(p => p.id === projectId);
            const projectName = project ? project.name : '';
            
            // Crear objetos de fecha completos
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            
            // Si la hora de fin es anterior a la de inicio, asumir que es del día siguiente
            if (endDateTime < startDateTime) {
                endDateTime.setDate(endDateTime.getDate() + 1);
            }
            
            const newEntry = {
                date,
                projectId,
                projectName,
                startTime: startDateTime.toISOString(),
                endTime: endDateTime.toISOString(),
                breakTime: parseInt(breakTime),
                colleagues,
                notes,
                createdAt: new Date().toISOString()
            };
            
            const timeRef = database.ref(`users/${currentUser.uid}/timeEntries`);
            timeRef.push(newEntry);
            
            // Limpiar formulario
            document.getElementById('start-time').value = '';
            document.getElementById('end-time').value = '';
            document.getElementById('break-time').value = '30';
            document.getElementById('colleagues').value = '';
            document.getElementById('notes').value = '';
        }
        
        // Función para mostrar detalle de registro
        function showEntryDetail(entryId) {
            const entry = timeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Calcular horas
            const startTime = new Date(entry.startTime);
            const endTime = new Date(entry.endTime);
            const obHours = calculateOBHours(startTime, endTime, entry.breakTime || 0);
            
            const detailContent = document.getElementById('detail-content');
            detailContent.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div class="font-medium">Fecha:</div>
                    <div>${new Date(entry.startTime).toLocaleDateString()}</div>
                    
                    <div class="font-medium">Proyecto:</div>
                    <div>${entry.projectName || 'Sin proyecto'}</div>
                    
                    <div class="font-medium">Horario:</div>
                    <div>${new Date(entry.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(entry.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    
                    <div class="font-medium">${translations[language].totalHours}:</div>
                    <div>${formatHours(obHours.total)} h</div>
                    
                    <div class="font-medium">Descanso:</div>
                    <div>${entry.breakTime || 0} min</div>
                </div>
                
                <div class="pt-3">
                    <div class="font-medium">Desglose OB:</div>
                    <div class="grid grid-cols-5 gap-2 mt-2">
                        <div class="ob-base p-2 rounded text-center">
                            <div class="font-bold">${translations[language].baseSalary}</div>
                            <div>${formatHours(obHours.breakdown.base)} h</div>
                        </div>
                        <div class="ob-1 p-2 rounded text-center">
                            <div class="font-bold">OB 1</div>
                            <div>${formatHours(obHours.breakdown.ob1)} h</div>
                        </div>
                        <div class="ob-2 p-2 rounded text-center">
                            <div class="font-bold">OB 2</div>
                            <div>${formatHours(obHours.breakdown.ob2)} h</div>
                        </div>
                        <div class="ob-3 p-2 rounded text-center">
                            <div class="font-bold">OB 3</div>
                            <div>${formatHours(obHours.breakdown.ob3)} h</div>
                        </div>
                        <div class="ob-4 p-2 rounded text-center">
                            <div class="font-bold">OB 4</div>
                            <div>${formatHours(obHours.breakdown.ob4)} h</div>
                        </div>
                    </div>
                </div>
                
                ${entry.colleagues ? `
                <div class="pt-3">
                    <div class="font-medium">Compañeros:</div>
                    <div>${entry.colleagues}</div>
                </div>
                ` : ''}
                
                ${entry.notes ? `
                <div class="pt-3">
                    <div class="font-medium">Notas:</div>
                    <div>${entry.notes}</div>
                </div>
                ` : ''}
            `;
            
            document.getElementById('detail-modal').classList.remove('hidden');
        }
        
        // Función para eliminar registro de horas
        function deleteTimeEntry(entryId) {
            if (confirm('¿Estás seguro de que quieres eliminar este registro? Esta acción no se puede deshacer.')) {
                const entryRef = database.ref(`users/${currentUser.uid}/timeEntries/${entryId}`);
                entryRef.remove();
            }
        }
        
        // Función para exportar a PDF
        function exportToPDF() {
            // Simulación de exportación a PDF
            alert('La función de exportar a PDF se activaría aquí. En una implementación real, se usaría jsPDF y html2canvas.');
        }
        
        // Función para exportar a JSON
        function exportToJSON() {
            // Simulación de exportación a JSON
            alert('La función de exportar a JSON se activaría aquí. En una implementación real, se descargaría un archivo JSON.');
        }
        
        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer fecha actual en el campo de fecha
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('work-date').value = formattedDate;
            
            // Configurar años para el filtro
            const yearSelect = document.getElementById('filter-year');
            const currentYear = today.getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            // Configurar meses para el filtro
            const monthSelect = document.getElementById('filter-month');
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            // Inicializar Firebase Auth state observer
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Usuario logueado
                    currentUser = user;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('user-info').classList.remove('hidden');
                    
                    // Actualizar información de usuario
                    document.getElementById('user-name').textContent = user.displayName || user.email;
                    document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=random`;
                    
                    // Cargar datos del usuario
                    loadProjects(user.uid);
                    loadTimeEntries(user.uid);
                } else {
                    // Usuario no logueado
                    currentUser = null;
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                    document.getElementById('user-info').classList.add('hidden');
                }
            });
            
            // Event listeners
            document.getElementById('login-btn').addEventListener('click', () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const authMessage = document.getElementById('auth-message');
                
                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            });
            
            document.getElementById('register-btn').addEventListener('click', () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const authMessage = document.getElementById('auth-message');
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => {
                        // Usuario creado exitosamente
                    })
                    .catch((error) => {
                        authMessage.textContent = error.message;
                    });
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => {
                auth.signOut();
            });
            
            document.getElementById('new-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.remove('hidden');
            });
            
            document.getElementById('create-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.remove('hidden');
            });
            
            document.getElementById('cancel-project-btn').addEventListener('click', () => {
                document.getElementById('project-modal').classList.add('hidden');
            });
            
            document.getElementById('save-project-btn').addEventListener('click', createProject);
            
            document.getElementById('save-hours-btn').addEventListener('click', saveTimeEntry);
            
            document.getElementById('close-detail-btn').addEventListener('click', () => {
                document.getElementById('detail-modal').classList.add('hidden');
            });
            
            document.getElementById('export-pdf').addEventListener('click', exportToPDF);
            
            document.getElementById('export-json').addEventListener('click', exportToJSON);
            
            document.getElementById('language-select').addEventListener('change', (e) => {
                language = e.target.value;
                translateUI();
            });
            
            // Detectar estado de conexión
            window.addEventListener('online', () => {
                document.querySelector('#connection-status span').classList.remove('bg-red-500');
                document.querySelector('#connection-status span').classList.add('bg-green-500');
                document.querySelector('#connection-status span:last-child').textContent = 'Online';
            });
            
            window.addEventListener('offline', () => {
                document.querySelector('#connection-status span').classList.remove('bg-green-500');
                document.querySelector('#connection-status span').classList.add('bg-red-500');
                document.querySelector('#connection-status span:last-child').textContent = 'Offline';
            });
            
            // Extensión para obtener número de semana
            Date.prototype.getWeek = function() {
                const date = new Date(this.getTime());
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
                const week1 = new Date(date.getFullYear(), 0, 4);
                return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            };
        });
    </script>
</body>
</html>
